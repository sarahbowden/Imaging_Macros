# 1. Macros
## How To
- Save macro with extension .ijm
- Select a region of interest (ROI) from an imaged WMISH embryo
  - For most accurate results it is important to keep ROI selection size consistent across all embryos in analysis (see below)
- Quantify a set (biological replicates of a single condition) at once (Process > Batch > Macro)
- or individual images (Plugins > Macros > Run...)
- Copy from the results table to quantify

### **Important note**
- I always create a Results folder for each batch processing analysis, and then I check that the black mask covers the stained regions.
- Convert to Mask is a binary process and black is selected as the smallest coverage. If images have more staining than background, this may be flipped.
- If this is the case I either manually perform these steps to ensure the correct region is covered (you can use Image > Adjust > Threshold..., or invert the ROI).
- In theory, if the whole batch needs to be inverted, you can add an inversion line to the macro prior to Convert to Mask.

## Step-by-step process
1. Renames each file to make downstream processes simpler
2. Colour Deconvolution to identify BM-stained tissue / eliminate background colours
3. Selects purple (BM-stained) channel
4. Prevents FIJI from assumption background = dark
5. Creates a mask based on differences between staining and background
7. Analyses particles; counts number of punctae/regions (between 30-2500 px), and calculates area


![ROI example](/Macros/Example_ROI.jpg "ROI")  
_Above: Region of interest selected for this analysis in each stage 32 embryo._

# 2. Quantification script

## Getting started
Run the following line to install the dependencies for R:
```R
install.packages(c("ggplot2", "dplyr", "readr", "stringr", "rlang"))
```

## Input files
Input files are generated by calculating the Count and % Area in a defined region of interest (ROI) using ImageJ and must be in .csv format.
The structure of these files must be as follows:
| Condition |  Image_Name  | Count | % Area |
|-----------|--------------|-------|--------|
| A         | Snap1234.czi | 320   | 36.943 |
| A         | Snap1235.czi | 249   | 17.694 |
| B         | Snap1236.czi | 252   | 21.359 |
| B         | Snap1237.czi | 229   | 20.399 |
| UC        | Snap1238.czi | 315   | 22.337 |
| UC        | Snap1239.czi | 249   | 25.744 |

Controls should be labelled as "UC". Morpholino conditions should be labelled with "MO" at the end of the name. Rescue conditions should be labelled with "Rescue" at the end of the name.
## Usage
This script runs a folder containing .csv files through an R script and spits out ggplot files with calculated p values (wilcoxon rank sum test) for comparisons to the control (black) and comparisons of the morphant to the rescue (red). You must define arguments in the following order:
```bash
./run_quantification.sh [first argument: input directory] [second argument: output directory]
```
Currently, this code provides the plot as both a .pdf and a .tif. It also reports the number of samples in each condition.
###
As a general rule, ISH quantification is best used for calculating the percentage of the ROI which is stained. However, in some circumstances, calculating the number of cells stained in an ROI can be a useful metric of quantification (e.g. more cells are specified, but these cells are smaller). In these instances, you can use the count_run_quantification.sh file to plot data generated from the count rather than Area. (This can be repurposed for any other measure, it simply takes data from the third column rather than fourth and relabels graphs with "Count" to indicate which measurement is being analysed.)
